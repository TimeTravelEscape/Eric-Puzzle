<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Puzzle Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: url('background.png') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            z-index: -1;
        }

        .footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            animation: fadeIn 0.5s ease 0.6s both;
        }

        .credit-link {
            display: inline-block;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            color: #333;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .credit-link:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .credit-link .heart {
            color: #f44336;
            display: inline-block;
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 1400px;
            flex-wrap: wrap;
            animation: fadeIn 0.5s ease;
        }

        .timer-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 15px 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-width: 200px;
            text-align: center;
        }

        .timer {
            font-size: clamp(1.8em, 4vw, 2.2em);
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            transition: color 0.3s ease;
        }

        .timer.normal {
            color: #333;
        }

        .timer.warning {
            color: #ff9800;
        }

        .timer.critical {
            color: #f44336;
            animation: pulse 1s infinite;
        }

        .timer-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            touch-action: manipulation;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-start:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn-final {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-final:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hint-display {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            animation: fadeIn 0.3s ease;
        }

        .hint-text {
            color: #333;
            font-size: 1.15em;
            line-height: 1.6;
            text-align: center;
            font-weight: 500;
        }

        .puzzles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            animation: fadeIn 0.5s ease 0.2s both;
        }

        .puzzle-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            touch-action: manipulation;
        }

        .puzzle-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
        }

        .puzzle-card:active {
            transform: scale(0.98);
        }

        .puzzle-number {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .puzzle-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            margin-bottom: 18px;
            line-height: 1.3;
        }

        .hints-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hint-btn {
            background: linear-gradient(135deg, #f6f6f6 0%, #e9e9e9 100%);
            border: 1px solid rgba(0,0,0,0.1);
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hint-btn:active {
            transform: scale(0.98);
        }

        .hint-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .hint-btn:hover:not(:disabled) {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .hint-btn:hover:not(:disabled)::before {
            opacity: 0.1;
        }

        .hint-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hint-btn.used {
    opacity: 0.6;
    background: linear-gradient(135deg, #f6f6f6 0%, #e9e9e9 100%);
    cursor: not-allowed;
}

        .time-penalty {
            font-size: 0.9em;
            color: #f44336;
            font-weight: 600;
            white-space: nowrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            animation: slideUp 0.3s ease;
        }

        .modal-title {
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1.1em;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .modal-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .modal-btn:active {
            transform: scale(0.98);
        }

        .modal-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .win-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('winscreen.png') no-repeat center center;
            background-size: cover;
            z-index: 2000;
            animation: fadeIn 0.5s ease;
        }

        .win-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            padding: 40px;
            background: rgba(0,0,0,0.5);
            border-radius: 30px;
            backdrop-filter: blur(10px);
        }

        .win-title {
            font-size: clamp(2.5em, 6vw, 4em);
            font-weight: 700;
            text-shadow: 0 4px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .win-time {
            font-size: clamp(1.5em, 4vw, 2em);
            text-shadow: 0 2px 20px rgba(0,0,0,0.5);
        }

        .time-out-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            animation: fadeIn 0.5s ease;
        }

        .time-out-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            padding: 40px;
        }

        .time-out-title {
            font-size: clamp(2.5em, 6vw, 4em);
            font-weight: 700;
            color: #f44336;
            text-shadow: 0 4px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translate(-50%, -40%);
            }
            to { 
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-50%, -50%) translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translate(-50%, -50%) translateX(10px); }
        }

        /* Touch-friendly adjustments */
        @media (pointer: coarse) {
            .btn {
                padding: 18px 35px;
                font-size: 1.1em;
            }
            
            .hint-btn {
                padding: 16px 22px;
                font-size: 1.05em;
            }
            
            .modal-btn {
                padding: 16px;
                font-size: 1.2em;
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .footer {
                margin-top: 30px;
                padding: 15px;
            }
            
            .credit-link {
                font-size: 0.8em;
                padding: 8px 15px;
            }
            
            .top-bar {
                flex-direction: column;
                gap: 15px;
            }
            
            .timer-container {
                width: 100%;
                max-width: 300px;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .puzzles-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .hint-display {
                padding: 15px 20px;
            }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .puzzles-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .top-bar {
                flex-wrap: wrap;
            }
        }

        @media (min-width: 1201px) {
            .puzzles-grid {
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            }
        }
    
    /* HIDE MIDDLE WHITE BOX (all 8 hints) */
    #puzzleContainer { display: none !important; }

#backgroundGrid {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none; /* hidden by default */
    z-index: -2;
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4 columns */
    grid-template-rows: repeat(2, 1fr); /* 2 rows */
}
#backgroundGrid div {
    background-image: url('Background3.png');
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover; /* show full image inside each grid cell */
}


body.noOverlay::before {
    backdrop-filter: none !important;
    background: none !important;
    content: none !important;
}

</style>
</head>
<body>

<div id="backgroundGrid">
    <div></div><div></div><div></div><div></div>
    <div></div><div></div><div></div><div></div>
</div>

    <div class="top-bar">
        <button class="btn btn-start" id="startBtn" data-i18n="startButton">Start Game</button>
        
        <div class="timer-container">
            <div class="timer-label" data-i18n="timeRemaining">Time Remaining</div>
            <div class="timer normal" id="timer">00:00:00</div>
        </div>
        
        <button class="btn btn-final" id="finalBtn" disabled data-i18n="finalPuzzle">Final Puzzle</button>
    </div>

    <div class="hint-display" id="hintDisplay" style="display: none;">
        <div class="hint-title" id="hintTitle" style="font-weight:700;margin-bottom:8px;text-align:center;"></div>
        <div class="hint-text" id="hintText"></div>
    </div>

    <div id="extraBox" class="puzzle-card" style="max-width:800px;width:100%;margin:0 auto;"></div>
<div id="puzzleContainer" class="puzzle-card" style="max-width:800px;width:100%;margin:0 auto;"></div>
<!-- Third white box, same dimensions as the other two -->
<div id="thirdBox" class="puzzle-card" style="max-width:800px;width:100%;margin:0 auto;margin-top:20px;">
    <div id="thirdBoxTitle" class="puzzle-title"></div>
    <div id="thirdBoxHints" class="hints-container"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    function renderThirdBox(puzzleIndex) {
        if (typeof config !== 'undefined' && config.puzzles && config.puzzles[puzzleIndex]) {
            const puzzle = config.puzzles[puzzleIndex];
            document.getElementById('thirdBoxTitle').textContent = puzzle.title;
            const hintsContainer = document.getElementById('thirdBoxHints');
            hintsContainer.innerHTML = '';
            puzzle.hints.forEach((hint, idx) => {
                const btn = document.createElement('button');
                btn.className = 'hint-btn';
                btn.innerHTML = `Hint ${idx + 1} <span style="color:red;font-weight:bold;">-${hint.penalty}s</span>`;
                btn.dataset.puzzle = puzzleIndex;
                btn.dataset.hint = idx;
                btn.addEventListener('click', () => {
                    if (typeof showHint === 'function') {
                        showHint(puzzleIndex, idx, btn);
                    } else if (typeof gameState !== 'undefined') {
                        // Fallback direct penalty handling
                        btn.textContent = hint.text + ` (Penalty: ${hint.penalty}s)`;
                        btn.disabled = true;
                        if (!gameState.usedHints[puzzleIndex]) gameState.usedHints[puzzleIndex] = [];
                        if (!gameState.usedHints[puzzleIndex][idx]) {
                            gameState.remainingTime -= hint.penalty;
                            gameState.usedHints[puzzleIndex][idx] = true;
                        }
                        if (typeof updateTimerDisplay === 'function') {
                            updateTimerDisplay();
                        }
                        btn.classList.add('used');
                    }
                });
                hintsContainer.appendChild(btn);
            });
        }
    }

    // Hook into renderPuzzle to also update third box
    if (typeof renderPuzzle === 'function') {
        const originalRenderPuzzle = renderPuzzle;
        renderPuzzle = function(index) {
            originalRenderPuzzle(index);
            renderThirdBox(index);
        };
    }

    // Initial render
    if (typeof currentPuzzleIndex !== 'undefined') {
        renderThirdBox(currentPuzzleIndex);
    }
});
</script>

<div style="margin-top:20px;display:flex;gap:10px;justify-content:center;">
    <button class="btn" id="prevPuzzleBtn">Previous Puzzle</button>
    <button class="btn" id="nextPuzzleBtn">Next Puzzle</button>
</div>

    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h2 class="modal-title" data-i18n="enterPassword">Enter Password</h2>
            <input type="text" class="modal-input" id="passwordInput" placeholder="Enter the final answer...">
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelBtn" data-i18n="cancel">Cancel</button>
                <button class="modal-btn modal-submit" id="submitBtn" data-i18n="submit">Submit</button>
            </div>
        </div>
    </div>

    <div class="win-screen" id="winScreen">
        <div class="win-overlay">
            <h1 class="win-title" data-i18n="congratulations">Congratulations!</h1>
            <p class="win-time" id="finalTime"></p>
        </div>
    </div>

    <div class="time-out-overlay" id="timeOutScreen">
        <div class="time-out-content">
            <h1 class="time-out-title" data-i18n="timeOut">Time's Up!</h1>
            <button class="btn btn-start" onclick="location.reload()" data-i18n="tryAgain">Try Again</button>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="translations.js"></script>
    <script>
        // Store solved answers so they persist
        let solvedAnswers = {};

        // Game state
        let gameState = {
            isRunning: false,
            remainingTime: 0,
            timerInterval: null,
            usedHints: new Set(),
            currentHint: null
        };

        // Initialize game
        function initGame() {
            loadTranslations();
            setupEventListeners();
            // Set initial puzzle and time display
            renderPuzzle(currentPuzzleIndex);
            updateTimerDisplay(config.startTimeSeconds || 3600);
            // Render independent hints section (does not change with top navigation)
            renderHintsSection();
        }

        // Load translations
        function loadTranslations() {
            const userLang = navigator.language.split('-')[0];
            const lang = translations[userLang] || translations['en'];
            
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (lang[key]) {
                    element.textContent = lang[key];
                }
            });
        }

        // Render single puzzle view
        let currentPuzzleIndex = 0;

        
// --- Answer checking helpers --- //
function levenshtein(a, b) {
    const m = a.length, n = b.length;
    if (m === 0) return n;
    if (n === 0) return m;
    const dp = Array.from({ length: m + 1 }, () => new Array(n + 1));
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            const cost = a[i - 1] === b[j - 1] ? 0 : 1;
            dp[i][j] = Math.min(
                dp[i - 1][j] + 1,
                dp[i][j - 1] + 1,
                dp[i - 1][j - 1] + cost
            );
        }
    }
    return dp[m][n];
}

const numberWords = {
    "zero": "0","one": "1","two": "2","three": "3","four": "4",
    "five": "5","six": "6","seven": "7","eight": "8","nine": "9",
    "ten": "10","eleven": "11","twelve": "12","thirteen": "13",
    "fourteen": "14","fifteen": "15","sixteen": "16","seventeen": "17",
    "eighteen": "18","nineteen": "19","twenty": "20"
};

function normalizeAnswer(ans) {
    if (!ans) return "";
    ans = ans.trim().toLowerCase();
    if (numberWords[ans] !== undefined) {
        return numberWords[ans];
    }
    return ans;
}

function isNumeric(str) {
    return /^[0-9]+$/.test(str);
}

function answersMatch(userAnswer, correctAnswer) {
    const normUser = normalizeAnswer(userAnswer);
    const normCorrect = normalizeAnswer(correctAnswer);
    if (isNumeric(normCorrect)) {
        return normUser === normCorrect; // strict for numbers
    } else {
        return (normUser === normCorrect || levenshtein(normUser, normCorrect) <= 2);
    }
}


function renderPuzzle(index) {
    // Switch background: default or 4x4 grid of identical Background3.pngs
    const grid = document.getElementById('backgroundGrid');
    if (index === 2) {
        document.body.classList.add("noOverlay");
        document.body.style.background = "none";
        if (grid) grid.style.display = "grid";
    } else {
        document.body.classList.remove("noOverlay");
        document.body.style.background = "url('background.png') no-repeat center center fixed";
        document.body.style.backgroundSize = "cover";
        if (grid) grid.style.display = "none";
    }
    renderHintsSection(index);
    const extraBox = document.getElementById('extraBox');
    const isSolved = solvedAnswers[index];
    const currentAnswer = isSolved || '';

    extraBox.innerHTML = `
        ${index === 0 ? '<div style="font-weight:700;margin-bottom:10px;text-align:center;">The Professor and friends have been pushed into the time machine and are now travelling through time! The only clue you have seemed to find is an old iPod with a music playlist sitting on a table. With the Professor explaining that the control panel to stop the time machine is locked with a 5-digit number… there must be a way you can help crack the code and save everyone!</div>' : ''}
        ${index === 1 ? '<div style="font-weight:700;margin-bottom:10px;text-align:center;">Thanks to you, the time machine has stopped hurling through time! But now, at the door to exit, the time machine has a strange Riddle that pops up on the exit LED screen. The Riddle says: I am inside you, but you didn’t eat me. I cannot stand up on my own, but I will outlast you. The answer is key to your survival. What am I? You must now help the team solve this riddle by entering a 2-digit number!</div>' : ''}
        ${index === 2 ? '<div style="font-weight:700;margin-bottom:10px;text-align:center;">The Professor praises you as your code unlocks the door. Good Job! You now step into the world of dinosaurs! Recognizing some iconic dinosaurs like the Triceratops and Brontosaurus, you can’t help but be amazed at this working Time Machine! When you and your new friends spot a T-rex in the distance, it seems like it’s time to go, and you race inside! Yet once again, the Professor tells you with frustration that the controls are locked and you can’t get back to your own time! With your friends handing you a piece of paper with dinosaurs printed on it that they found outside, it’s time for you to put your brains together to see if you can find a 6-letter word to enter. Perhaps the symbols of dinosaurs might help you unlock the missing word!</div>' : ''}
        ${index === 3 ? '<div style="font-weight:700;margin-bottom:10px;text-align:center;">The answer was Velcro! Entering the password successfully, the time machine starts, and you begin to feel yourself moving forward in time! With a sudden jolt, the time machine begins to slow down and yet again stops. With a woosh, the doors open automatically, and you find yourself in the Jungle with strange pyramids and animals in the background. The computer screen in the time machine beeps yet again, asking for another password, this time a 3-digit number. Spotting some clues outside on an old parchment, you begin to wonder if this could be the strange clue you may need to help continue your and the team\'s journey through time!</div>' : ''}
        ${index === 4 ? '<div style="font-weight:700;margin-bottom:10px;text-align:center;">You enter another clue successfully, and you travel yet again forward in time! The time machine slows down, and yet again, the Professor and friends need your help to open those pesky doors that lead outside. The only clue pops up on an LED panel beside the exit door, stating: You must find the CODE that will not BAR your way.</div>' : ''}
        ${index === 5 ? '<div style="font-weight:700;margin-bottom:10px;text-align:center;">Solving the Bar Code puzzle, the answers help set you free into a land of…candy? With distant songs and tiny green-haired characters dancing around, it almost feels like you\\\'re in a movie set of some kind. With your thoughts interrupted, you notice you must have interrupted a game of Scrabble, as there seem to be Scrabble tiles everywhere! With a heavy sigh, you turn around and see the computer asking for another password, this time an 11-digit password! With a sigh, you and your team get back to solving another strange clue.</div>' : ''}
        ${index === 6 ? '<div style="font-weight:700;margin-bottom:10px;text-align:center;">The number succeeds, and with your team piled into the time machine, the Professor takes the helm and propels you all forward in time. This time, a warning light sounds and a bright light soon shows, displaying a text that you\'re out of gas! With a curse, the Professor halts the time machine, only to find that the machine has seemed to overshot your time by at least a few thousand years! With flying cars and robots everywhere, this truly seems like one crazy future!  Three strange, futuristic people and machines soon approach you outside your time machine, stating that they’ve been expecting you. They say that they have three puzzles that have been haunting them that you will need to solve, and in return will give you the fuel needed to return home!  The first to approach is a futuristic-looking Robot, the machine beeps that this is a puzzle only a true genius can solve! Do you know the answer?</div>' : ''}
        ${index === 7 ? '<div style="font-weight:700;margin-bottom:10px;text-align:center;">With the Clue solved, a robed man approaches wearing a strange watch. He claims that this puzzle is the next step to reaching your goal and that only a special person may have a hand in solving this clue. The only other hint he gives is that it’s a one-digit number.</div>' : ''}
        ${index === 8 ? '<div style="font-weight:700;margin-bottom:10px;text-align:center;">Yet again, you make it! The Third figure emerges and claims this is the last question, with the fuel needed to get back to your own time to be rewarded! Can you solve what’s missing?</div>' : ''}
        ${index === 9 ? '<div style="font-weight:700;margin-bottom:10px;text-align:center;">Solving all the clues, you can’t help but swell with pride as the Professor compliments you on a job well done! Even he would have struggled with most of those tricky puzzles! Fully fueled, he begins to take you and your colleagues backwards in time, this time claiming to have the correct time!  Within a few minutes (or perhaps centuries?), you all find yourself right back to where you started, the clock on the wall displaying how it has only been a few minutes from when you first disappeared. Unfortunately, exiting the time machine, you can’t help but notice something ominous inside the lab. It appears the tricks don’t seem done, as it quickly becomes apparent that the doors to the lab are locked, and with a bomb being found locked in with you in the middle of the lab! Panicking, the Professor starts hitting buttons on the bomb to deactivate it, only for bubbles and slime to start shooting out of the machine at a supernatural rate. It seems you only have minutes to figure out this password before the room is filled with what appears to be a growing amount of slime and outlandish bubbles! With a quick look around the room, you take note of what looks like your final clue to escaping this precarious situation.</div>' : ''}
        ${index === 10 ? '<div style="font-weight:700;margin-bottom:10px;text-align:center;">The bomb slowly stops after entering the correct code. Success! Then with an ominous “Beep,” the bomb springs to life, the timer resetting and counting down from 5 minutes. It looks like you have one final puzzle to solve to deactivate this bomb for good! Looking at the back, you find a panel that has popped open, revealing a plethora of black wires, gears, and strange numbers and symbols. It appears you’ll have to deactivate by entering one final code, but you’ll have to trace the right wires. Good luck!</div>' : ''}
        <img src="Puzzle${index + 1}.png" alt="Puzzle ${index + 1}" style="width:100%;border-radius:15px;display:block;margin-bottom:15px;">
        <div style="font-weight:700;margin-top:10px;">Your Answer</div>
        <input id="answerInput" type="text" value="${currentAnswer}" placeholder="Type your answer..." style="width:100%;padding:10px;border:2px solid #ccc;border-radius:8px;margin-top:5px;">
    `;

    const answerInput = document.getElementById('answerInput');
    const nextBtn = document.getElementById('nextPuzzleBtn');

    // Keep solved puzzles green and next enabled
    if (isSolved) {
        answerInput.style.border = "4px solid green";
                answerInput.style.boxShadow = "0 0 10px 4px rgba(0, 255, 0, 0.7)";
        nextBtn.disabled = false;
    } else {
        answerInput.style.borderColor = "#ccc";
        answerInput.style.boxShadow = "none";
        nextBtn.disabled = true;
    }

    answerInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault(); // stop form submission or default behavior
            const correctAnswer = config.puzzleAnswers[index].trim().toLowerCase();
            const userAnswer = answerInput.value.trim().toLowerCase();

            // Special case: Puzzle index 7 (puzzle 8) accepts "4" or "time"
if ((index === 7 && (answersMatch(userAnswer, correctAnswer) || normalizeAnswer(userAnswer) === "time")) 
    || answersMatch(userAnswer, correctAnswer)) {
                answerInput.style.border = "4px solid green";
                answerInput.style.boxShadow = "0 0 10px 4px rgba(0, 255, 0, 0.7)";
                solvedAnswers[index] = answerInput.value.trim();
                nextBtn.disabled = false;
            } else {
                answerInput.style.border = "4px solid red";
                answerInput.style.boxShadow = "0 0 10px 4px rgba(255, 0, 0, 0.7)";
                nextBtn.disabled = true;
            }

            // Force repaint so style change is visible immediately
            void answerInput.offsetHeight;
        }
    });
}


function setupEventListeners() {
            // Start button
            document.getElementById('startBtn').addEventListener('click', startGame);
            
            // Final puzzle button
            document.getElementById('finalBtn').addEventListener('click', showPasswordModal);
            
            // Password modal
            document.getElementById('cancelBtn').addEventListener('click', hidePasswordModal);
            document.getElementById('submitBtn').addEventListener('click', checkPassword);
            document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkPassword();
            });
            
            // Hint buttons - using event delegation for better touch support
            document.getElementById('puzzleContainer').addEventListener('click', (e) => {
                const hintBtn = e.target.closest('.hint-btn');
                if (hintBtn && !hintBtn.disabled) {
                    const puzzleIndex = parseInt(hintBtn.dataset.puzzle);
                    const hintIndex = parseInt(hintBtn.dataset.hint);
                    showHint(puzzleIndex, hintIndex, hintBtn);
                }
            });

            // Navigation buttons (always visible and wrap around)
            document.getElementById('prevPuzzleBtn').addEventListener('click', () => {
                currentPuzzleIndex = (currentPuzzleIndex - 1 + config.puzzles.length) % config.puzzles.length;
                renderPuzzle(currentPuzzleIndex);
            });
            document.getElementById('nextPuzzleBtn').addEventListener('click', () => {
                currentPuzzleIndex = (currentPuzzleIndex + 1) % config.puzzles.length;
                renderPuzzle(currentPuzzleIndex);
            });

            // Prevent context menu on long press (touch devices)
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });
        }

        // Start game
        function startGame() {
            gameState.isRunning = true;
            gameState.remainingTime = config.startTimeSeconds || 3600; // Default 1 hour
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('finalBtn').disabled = false;
            
            // Start countdown timer
            gameState.timerInterval = setInterval(updateTimer, 100);
        }

        // Update timer
        function updateTimer() {
            if (!gameState.isRunning) return;
            
            gameState.remainingTime -= 0.1;
            
            if (gameState.remainingTime <= 0) {
                gameState.remainingTime = 0;
                gameState.isRunning = false;
                clearInterval(gameState.timerInterval);
                showTimeOut();
            }
            
            updateTimerDisplay(gameState.remainingTime);
        }

        // Update timer display
        function updateTimerDisplay(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            const display = `${pad(hours)}:${pad(minutes)}:${pad(secs)}`;
            const timerElement = document.getElementById('timer');
            timerElement.textContent = display;
            
            // Update timer color based on remaining time
            timerElement.className = 'timer';
            if (seconds <= 60) {
                timerElement.className = 'timer critical';
            } else if (seconds <= 300) {
                timerElement.className = 'timer warning';
            } else {
                timerElement.className = 'timer normal';
            }
        }

        // Show hint
        function showHint(puzzleIndex, hintIndex, button) {
            if (!gameState.isRunning) {
                alert(translations[config.language || 'en'].startGameFirst || 'Please start the game first!');
                return;
            }

            const hintKey = `${puzzleIndex}-${hintIndex}`;
            const puzzle = config.puzzles[puzzleIndex];
            const hint = puzzle.hints[hintIndex];
            
            // Apply penalty if first time using this hint
            if (!gameState.usedHints.has(hintKey)) {
                gameState.remainingTime -= hint.penalty;
                if (gameState.remainingTime < 0) gameState.remainingTime = 0;
                gameState.usedHints.add(hintKey);
                button.classList.add('used');
            }
            
            // Display hint directly below timer
            const hintDisplay = document.getElementById('hintDisplay');
            const hintText = document.getElementById('hintText');
            
            hintText.textContent = hint.text;
            hintDisplay.style.display = 'block';
            
            // Scroll to top to see the hint
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show password modal
        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }

        // Hide password modal
        function hidePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordInput').value = '';
        }

        // Check password
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            
            if (input.toLowerCase() === config.finalPassword.toLowerCase()) {
                // Stop timer
                gameState.isRunning = false;
                clearInterval(gameState.timerInterval);
                
                // Hide modal
                hidePasswordModal();
                
                // Show win screen
                showWinScreen();
            } else {
                // Wrong password - shake animation
                const modal = document.querySelector('.modal-content');
                modal.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    modal.style.animation = '';
                }, 500);
            }
        }

        // Show win screen
        function showWinScreen() {
            const totalSeconds = config.startTimeSeconds || 3600;
            const usedSeconds = totalSeconds - gameState.remainingTime;
            const hours = Math.floor(usedSeconds / 3600);
            const minutes = Math.floor((usedSeconds % 3600) / 60);
            const seconds = Math.floor(usedSeconds % 60);
            
            const lang = translations[config.language || 'en'];
            document.getElementById('finalTime').textContent = 
                `${lang.completedIn || 'Completed in'}: ${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            
            document.getElementById('winScreen').style.display = 'block';
        }

        // Show time out screen
        function showTimeOut() {
            document.getElementById('timeOutScreen').style.display = 'block';
        }

        // Utility function to pad numbers
        function pad(num) {
            return num.toString().padStart(2, '0');
        }

        // Initialize on load
        
function renderHintsSection() {
    const puzzleContainer = document.getElementById('puzzleContainer');
    if (!puzzleContainer) return;
    puzzleContainer.innerHTML = ''; // clear

    if (typeof config === 'undefined' || !Array.isArray(config.puzzles) || config.puzzles.length === 0) {
        puzzleContainer.innerHTML = '<div style="padding:12px;color:#666;text-align:center;">No hints available.</div>';
        return;
    }

    // We'll render hints for ALL puzzles so this section is independent of the top navigation
    config.puzzles.forEach((puzzle, pIndex) => {
        const title = document.createElement('div');
        title.className = 'puzzle-title';
        title.textContent = puzzle.title || ('Puzzle ' + (pIndex + 1));
        puzzleContainer.appendChild(title);

        const hintsDiv = document.createElement('div');
        hintsDiv.className = 'hints-container';

        const hints = Array.isArray(puzzle.hints) ? puzzle.hints : [];
        if (hints.length === 0) {
            const ph = document.createElement('div');
            ph.style.color = '#666';
            ph.style.padding = '12px';
            ph.style.textAlign = 'center';
            ph.textContent = 'No hints for this puzzle.';
            hintsDiv.appendChild(ph);
        } else {
            hints.forEach((hint, hintIndex) => {
                const btn = document.createElement('button');
                btn.className = 'hint-btn';
                btn.setAttribute('data-puzzle', String(pIndex));
                btn.setAttribute('data-hint', String(hintIndex));

                const labelSpan = document.createElement('span');
                try {
                    const lang = (config && config.language) ? config.language : 'en';
                    labelSpan.textContent = (typeof translations !== 'undefined' && translations[lang] && translations[lang].hint) ? translations[lang].hint + ' ' + (hintIndex + 1) : 'Hint ' + (hintIndex + 1);
                } catch (e) {
                    labelSpan.textContent = 'Hint ' + (hintIndex + 1);
                }

                const penaltySpan = document.createElement('span');
                penaltySpan.className = 'time-penalty';
                penaltySpan.textContent = '-' + (typeof hint.penalty === 'number' ? hint.penalty : (hint.penalty ? Number(hint.penalty) : 0)) + 's';

                // Append label and penalty (label first so penalty shows at right due to flex)
                btn.appendChild(labelSpan);
                btn.appendChild(penaltySpan);

                btn.addEventListener('click', function() {
                    if (!gameState.isRunning) {
                        alert((translations && translations[config.language] && translations[config.language].startGameFirst) || 'Please start the game first!');
                        return;
                    }
                    const hintKey = pIndex + '-' + hintIndex;
                    if (!gameState.usedHints.has(hintKey)) {
                        gameState.remainingTime = Math.max(0, gameState.remainingTime - (typeof hint.penalty === 'number' ? hint.penalty : (hint.penalty ? Number(hint.penalty) : 0)));
                        gameState.usedHints.add(hintKey);
                        btn.classList.add('used');
                    }
                    // reveal the hint in the top hintDisplay area
                    const hintDisplay = document.getElementById('hintDisplay');
                    const hintText = document.getElementById('hintText');
                    if (hintText && hintDisplay) {
                        hintText.textContent = hint.text || '';
                        hintDisplay.style.display = 'block';
                        // scroll to top so the player sees it
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        // fallback: alert the hint
                        alert(hint.text || '');
                    }
                });

                hintsDiv.appendChild(btn);
            });
        }

        puzzleContainer.appendChild(hintsDiv);
    });
}


document.addEventListener('DOMContentLoaded', initGame);

        // Prevent bounce scrolling on iOS
        document.addEventListener('touchmove', function(e) {
            if (e.target.closest('.puzzles-grid')) {
                return;
            }
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
